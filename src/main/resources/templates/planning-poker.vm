$webResourceManager.requireResource("com.atlassian.auiplugin:ajs")
$webResourceManager.requireResource("com.atlassian.auiplugin:aui-select2")
$webResourceManager.requireResource("com.atlassian.auiplugin:aui-tooltips")
$webResourceManager.requireResource("com.atlassian.auiplugin:aui-badge")
$webResourceManager.requireResource("com.aprey.jira.plugin.openpoker.open-poker:open-poker-resources")

<input type="hidden" id="open-poker-js-issueId" value="$issueId"/>
<input type="hidden" id="open-poker-js-userId" value="$userId"/>
<input type="hidden" id="open-poker-js-contextPath" value="$contextPath"/>
<input type="hidden" id="open-poker-js-session-status" value="$viewDTO.getSession().getStatus()"/>

#if($viewDTO)
    #if($viewDTO.getSession().getStatus() == "IN_PROGRESS")
    <ul class="item-details">
        <li class="people-details">
            <dl>
                <dt>Initiated by:</dt>
                <dd>
        <span class="view-issue-field inactive">

    <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner"><img
            src="$viewDTO.getModerator().getAvatarUrl()"
            alt="$viewDTO.getModerator().getDisplayName()"></span></span>
            $viewDTO.getModerator().getDisplayName()
        </span>
                    </span>
                </dd>
            </dl>
        </li>
        <li class="people-details">
            <dl>
                <dt>Estimated By:</dt>
                <dd id="open-poker-js-estimators">
                    #if($viewDTO.getEstimation().getEstimates().size() == 0)
                        none
                    #else
                        #foreach($estimate in $viewDTO.getEstimation().getEstimates())
                            <span class="aui-avatar aui-avatar-small">
                                <span class="aui-avatar-inner op-estimator-tooltip"
                                      data-title="$estimate.getEstimator().getDisplayName()"
                                      title="$estimate.getEstimator().getDisplayName()">
                                    <img src="$estimate.getEstimator().getAvatarUrl()"
                                         alt="$estimate.getEstimator().getDisplayName()">
                                </span>
                            </span>
                        #end
                    #end
                </dd>
            </dl>
        </li>
        <li class="people-details">
            <dl>
                <dt>Status:</dt>
                <dd>
                    $viewDTO.getSession().getStatus().getName()
                </dd>
            </dl>
        </li>
        #if($currentEstimate)
            <li class="people-details">
                <dl>
                    <dt>Previous Estimate:</dt>
                    <dd>
                        <aui-badge class="aui-badge-primary">$currentEstimate</aui-badge>
                    </dd>
                </dl>
            </li>
        #end
    </ul>

    <form action="$contextPath/plugins/servlet/open-poker/session" method="post" class="aui left-aligned-form"
          style="margin-top: 5px">
        <input name="issueId" value="$issueId" type="hidden"/>
        <input name="userId" value="$userId" type="hidden"/>
        #if(!$viewDTO.getEstimation().isAlreadyVoted())
            <div class="field-group">
                <label for="estimationInfo">Your Estimate:</label>
                <select name="estimationGradeId" placeholder="Choose Estimate" style="max-width: 170px"
                        no-empty-values="false" class="op-aui-select">
                    <option class="imagebacked" value="">Choose estimate</option>
                    #foreach($grade in $viewDTO.getEstimation().getGradesToChoose())
                        <option class="imagebacked" value="$grade.getId()">$grade.getValue()</option>
                    #end
                </select>
            </div>
        #end
        <p>
            #if(!$viewDTO.getEstimation().isAlreadyVoted())
                <input name="action" type="submit" value="Vote" class="aui-button aui-button-primary"
                       style="margin-top: 5px"/>
            #end
            #if($userId == $viewDTO.getSession().getModerator().getId())
                <input name="action" type="submit" value="Stop Estimation" class="aui-button" style="margin-top: 5px"/>
            #end
        </p>
    </form>
    #elseif($viewDTO.getSession().getStatus() == "FINISHED")
    <table class="aui aui-table-list" style="max-width: 355px">
        <thead>
        <tr>
            <th id="estimator">Estimator</th>
            <th id="estimate">Estimate</th>
        </tr>
        </thead>
        <tbody>
            #foreach($estimate in $viewDTO.getEstimation().getEstimates())
            <tr>
                <td headers="estimator">
                <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner">
                    <img
                            src="$estimate.getEstimator().getAvatarUrl()"
                            alt="admin"></span></span>
                    $estimate.getEstimator().getDisplayName()
                </td>
                <td headers="estimate" class="open-poker-estimate-grade">
                    $estimate.getGrade()
                </td>
            </tr>
            #end
        </tbody>
    </table>
    <div style="width: 35%; margin: 20px; max-width: 200px;">
        <canvas id="open-poker-results-chart" width="100" height="100"></canvas>
    </div>
    <form action="$contextPath/plugins/servlet/open-poker/session" method="post" class="aui left-aligned-form">
        #set( $greadesToApplyEmpty = $viewDTO.getEstimation().getGradesToApply().isEmpty())
        #if($greadesToApplyEmpty == false)
            <div class="field-group">
                <label for="estimationInfo">Final Estimate:</label>
                <select name="resultingEstimate" placeholder="Resulting Estimate" style="max-width: 70px"
                        no-empty-values="false" class="op-aui-select">
                    #foreach($grade in $viewDTO.getEstimation().getGradesToApply())
                        #if($grade.getId() == $viewDTO.getEstimation().getAverageEstimateId())
                            <option class="imagebacked" value="$grade.getValue()" selected>$grade.getValue()</option>
                        #else
                            <option class="imagebacked" value="$grade.getValue()">$grade.getValue()</option>
                        #end
                    #end
                </select>
            </div>
        #end
        <div style="margin-top: 20px">
            <p>
                <input name="issueId" value="$issueId" type="hidden"/>
                <input name="userId" value="$userId" type="hidden"/>
                #if($greadesToApplyEmpty == false)
                    <input name="action" type="submit" value="Apply Estimate" class="aui-button aui-button-primary"/>
                #else
                    <input name="action" type="submit" value="End Session" class="aui-button aui-button-primary"/>
                #end
                <input name="action" type="submit" value="Re-estimate" class="aui-button"/>
            </p>
        </div>
    </form>
    #end
#else
<div>
    #if($currentEstimate)
        <ul class="item-details">
            <li class="people-details">
                <dl>
                    <dt>Current Estimate:</dt>
                    <dd>
                        <aui-badge class="aui-badge-primary">$currentEstimate</aui-badge>
                    </dd>
                </dl>
            </li>
        </ul>
    #end
    <p>
    <form action="$contextPath/plugins/servlet/open-poker/session" method="post">
        <input name="issueId" value="$issueId" type="hidden"/>
        <input name="userId" value="$userId" type="hidden"/>
        #if($currentEstimate)
            <input name="action" type="submit" value="Re-estimate" class="aui-button"/>
        #else
            <input name="action" type="submit" value="Start Estimation" class="aui-button"/>
        #end
    </form>
    </p>
</div>
#end