$webResourceManager.requireResource("com.atlassian.auiplugin:ajs")
$webResourceManager.requireResource("com.atlassian.auiplugin:aui-select2")
$webResourceManager.requireResource("com.atlassian.auiplugin:aui-tooltips")
$webResourceManager.requireResource("com.atlassian.auiplugin:aui-badge")
$webResourceManager.requireResource("com.atlassian.auiplugin:aui-buttons")
$webResourceManager.requireResource("com.atlassian.auiplugin:aui-experimental-iconfont")
$webResourceManager.requireResource("com.aprey.jira.plugin.openpoker.open-poker:open-poker-resources")

<input type="hidden" id="open-poker-js-issueId" value="$issueId"/>
<input type="hidden" id="open-poker-js-userId" value="$userId"/>
<input type="hidden" id="open-poker-js-contextPath" value="$contextPath"/>
<input type="hidden" id="open-poker-js-session-status" value="$viewDTO.getSession().getStatus()"/>

#if($viewDTO)
    #if($viewDTO.getSession().getStatus() == "IN_PROGRESS")
    <ul class="item-details open-poker-table">
        <li class="people-details">
            <dl>
                <dt>Initiated by:</dt>
                <dd>
        <span class="view-issue-field inactive">

    <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner"><img
            src="$viewDTO.getModerator().getAvatarUrl()"
            alt="$viewDTO.getModerator().getDisplayName()"></span></span>
            $viewDTO.getModerator().getDisplayName()
        </span>
                    </span>
                    <span class="open-poker-terminate-estimation-link">
                            <a>Terminate estimation</a>
                    </span>
                </dd>
            </dl>
        </li>
        <li class="people-details">
            <dl>
                <dt>Status:</dt>
                <dd>
                    $viewDTO.getSession().getStatus().getName()
                </dd>
            </dl>
        </li>
        <li class="people-details">
            <dl>
                <dt>Estimated By:</dt>
                <dd id="open-poker-js-estimators">
                    #if($viewDTO.getEstimation().getEstimates().size() == 0)
                        none
                    #else
                        #foreach($estimate in $viewDTO.getEstimation().getEstimates())
                            <span class="aui-avatar aui-avatar-small">
                                <span class="aui-avatar-inner op-estimator-tooltip"
                                      data-title="$estimate.getEstimator().getDisplayName()"
                                      title="$estimate.getEstimator().getDisplayName()">
                                    <img src="$estimate.getEstimator().getAvatarUrl()"
                                         alt="$estimate.getEstimator().getDisplayName()">
                                </span>
                            </span>
                        #end
                    #end
                </dd>
            </dl>
        </li>
        #if($currentEstimate && !$viewDTO.getEstimation().isAlreadyVoted())
            <li class="people-details">
                <dl>
                    <dt>Current Estimate:</dt>
                    <dd>
                        <aui-badge class="aui-badge-primary">$currentEstimate</aui-badge>
                    </dd>
                </dl>
            </li>
        #end
    </ul>

    <form action="$contextPath/plugins/servlet/open-poker/session" method="post" class="aui left-aligned-form"
          style="margin-top: 5px">
        <input name="issueId" value="$issueId" type="hidden"/>
        <input name="userId" value="$userId" type="hidden"/>
        #if(!$viewDTO.getEstimation().isAlreadyVoted())
            <div class="field-group">
                <label for="estimationInfo">Your Estimate:</label>
                <select name="estimationGradeId" placeholder="Choose Estimate" style="max-width: 160px"
                        no-empty-values="false" class="op-aui-select">
                    <option class="imagebacked" value="">Choose estimate</option>
                    #foreach($grade in $viewDTO.getEstimation().getEstimationGrades())
                        <option class="imagebacked" value="$grade.getId()">$grade.getValue()</option>
                    #end
                </select>
            </div>
        #end

        <div class="open-poker-btn-group aui-buttons">
            #if(!$viewDTO.getEstimation().isAlreadyVoted())
                <input name="action" type="submit" value="Estimate" class="aui-button aui-button-split-main"/>
            #end
            #if($userId == $viewDTO.getSession().getModerator().getId())
                <input name="action" type="submit" value="Stop Estimation" class="aui-button"/>
            #end
            <input name="action" type="submit" value="Terminate" class="aui-button open-poker-terminate-estimation-btn"
                   style="display: none;"/>
        </div>

    </form>
    #elseif($viewDTO.getSession().getStatus() == "FINISHED")
    <table class="aui aui-table-list" style="max-width: 355px">
        <thead>
        <tr>
            <th id="estimator">Estimator</th>
            <th id="estimate">Estimate</th>
        </tr>
        </thead>
        <tbody>
            #foreach($estimate in $viewDTO.getEstimation().getEstimates())
            <tr>
                <td headers="estimator">
                <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner">
                    <img
                            src="$estimate.getEstimator().getAvatarUrl()"
                            alt="admin"></span></span>
                    $estimate.getEstimator().getDisplayName()
                </td>
                <td headers="estimate" class="open-poker-estimate-grade">
                    $estimate.getGrade()
                </td>
            </tr>
            #end
        </tbody>
    </table>
    <div style="width: 35%; margin: 20px; max-width: 200px;">
        <canvas id="open-poker-results-chart" width="100" height="100"></canvas>
    </div>
    <form action="$contextPath/plugins/servlet/open-poker/session" method="post" class="aui left-aligned-form">

        <div class="field-group">
            <label for="estimationInfo">Final Estimate:</label>
            <select name="finalEstimateId" placeholder="Resulting Estimate" style="max-width: 100px"
                    no-empty-values="false" class="op-aui-select">
                #foreach($grade in $viewDTO.getEstimation().getEstimationGrades())
                    #if($grade.getId() == $viewDTO.getEstimation().getAverageEstimateId())
                        <option class="imagebacked" value="$grade.getId()" selected>$grade.getValue()</option>
                    #else
                        <option class="imagebacked" value="$grade.getId()">$grade.getValue()</option>
                    #end
                #end
            </select>
        </div>
        <div style="margin-top: 20px" class="aui-buttons">
            <p>
                <input name="issueId" value="$issueId" type="hidden"/>
                <input name="userId" value="$userId" type="hidden"/>
                <span>$viewDTO.getCurrentScale().getName()</span>
                <input name="estimationScale" value="$viewDTO.getCurrentScale().getName()" type="hidden">
                <input name="action" type="submit" value="Apply" class="aui-button"/>
                <input name="action" type="submit" value="Re-estimate" class="aui-button"/>
            </p>
        </div>
    </form>
    #end
#else
<div>
    <p>
    <form action="$contextPath/plugins/servlet/open-poker/session" method="post" class="aui left-aligned-form"
          style="margin-top: 0px">
        #if($currentEstimate)
            <ul class="item-details">
                <li class="people-details">
                    <dl>
                        <dt>Current Estimate:</dt>
                        <dd>
                            <aui-badge class="aui-badge-primary">$currentEstimate</aui-badge>
                        </dd>
                    </dl>
                </li>
            </ul>
        #end
        <div class="field-group">
            <label for="estimationInfo">Estimation Scale:</label>
            <select name="estimationScale" placeholder="Choose Scale" style="max-width: 150px"
                    no-empty-values="false" class="op-aui-select">
                #foreach($unit in $estimationUnits)
                    <option class="imagebacked" value="$unit.getName()">$unit.getName()</option>
                #end
            </select>
        </div>

        <div style="margin-top: 10px">
            <input name="issueId" value="$issueId" type="hidden"/>
            <input name="userId" value="$userId" type="hidden"/>
            #if($currentEstimate)
                <input name="action" type="submit" value="Re-estimate" class="aui-button"/>
            #else
                <input name="action" type="submit" value="Start Estimation" class="aui-button"/>
            #end
        </div>
    </form>
    </p>
</div>
#end